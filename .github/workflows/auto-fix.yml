name: Auto Fix Misconfigurations

on:
  workflow_run:
    workflows: ["CI - Validate and Policy Gate"]
    types: [completed]

jobs:
  autofix:
    # Only run when:
    # - CI failed
    # - The CI was triggered by a pull_request
    # - There is at least one PR in the payload
    if: >
      ${{
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.event == 'pull_request' &&
        github.event.workflow_run.pull_requests[0].head.ref != ''
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      TARGET_BRANCH: ${{ github.event.workflow_run.pull_requests[0].head.ref }}

    steps:
      - name: Show workflow_run context (debug)
        run: |
          echo "Event: ${{ github.event.workflow_run.event }}"
          echo "Head branch (PR branch): ${{ github.event.workflow_run.pull_requests[0].head.ref }}"
          echo "Base branch (PR target): ${{ github.event.workflow_run.pull_requests[0].base.ref }}"

      - name: Checkout failing commit
        uses: actions/checkout@v4
        with:
          # The exact commit CI validated
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Create fix branch
        run: |
          BR="autofix/${{ github.event.workflow_run.id }}"
          echo "BRANCH_NAME=$BR" >> "$GITHUB_ENV"
          git checkout -b "$BR"

      - name: Apply auto remediation
        run: python3 scripts/autorem_fix.py

      - name: Commit changes
        run: |
          git config user.name "raas-bot"
          git config user.email "raas-bot@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected by auto remediation. Nothing to commit."
            exit 0
          fi
          git commit -m "Auto remediation: harden storage and RDP"

      - name: Push branch
        run: |
          git push origin "HEAD:refs/heads/${BRANCH_NAME}"

      - name: Create or update PR into PR branch
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          # Base is the PR head branch, not dev
          base: ${{ env.TARGET_BRANCH }}
          title: "Auto remediation for ${{ env.TARGET_BRANCH }}"
          body: |
            This PR was generated by the Remediation as a Service auto fix workflow.

            It applies:
            - Storage container access set to private
            - RDP 3389 restricted from the internet

            Review and merge to bring the branch back into policy.
