name: Auto Fix Misconfigurations

on:
  workflow_run:
    workflows: ["CI - Validate and Policy Gate"]
    types: [completed]

jobs:
  autofix:
    # Only run if the CI workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout failing commit
        uses: actions/checkout@v4
        with:
          # Checkout the exact commit that CI validated
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Create fix branch
        run: |
          BR="autofix/${{ github.event.workflow_run.id }}"
          echo "BRANCH_NAME=$BR" >> "$GITHUB_ENV"
          git checkout -b "$BR"

      - name: Apply auto remediation
        run: python3 scripts/autorem_fix.py

      - name: Commit changes
        run: |
          git config user.name "raas-bot"
          git config user.email "raas-bot@users.noreply.github.com"
          # Stage everything
          git add -A
          # If there are no changes, do not fail the job
          if git diff --cached --quiet; then
            echo "No changes detected by auto remediation. Exiting."
            exit 0
          fi
          git commit -m "Auto remediation: lock down storage and RDP"

      - name: Push branch
        run: |
          git push origin "HEAD"

      - name: Open Pull Request back to PR branch
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          base: ${{ github.event.workflow_run.head_branch }}
          title: "Auto remediation for ${{ github.event.workflow_run.head_branch }}"
          body: |
            This PR was generated by the Remediation as a Service auto fix workflow.

            It applies:
            - Storage container access set to private
            - RDP 3389 restricted from the internet

            Review and merge to bring the branch back into policy.
